# 日志高亮工具

这是一个强大的日志文件分析工具，专为开发人员、系统管理员和IT专业人员设计。本工具可帮助用户快速识别、高亮和分析日志文件中的关键信息，大幅提高日志分析效率。

## 主要功能

- **多格式日志支持**：支持纯文本、压缩文件(gz, zip, rar, 7z等)等多种日志格式
- **智能关键词高亮**：自动识别并高亮显示指定关键词，支持正则表达式
- **批量文件处理**：可同时分析多个日志文件或整个目录
- **高性能处理**：采用多线程/多进程技术，高效处理大型日志文件
- **内存优化**：针对超大文件实现了内存映射(mmap)和流式处理
- **可定制界面**：用户友好的PyQt5界面，支持关键词分组和颜色定制
- **HTML报告**：生成包含统计信息的HTML报告，便于分享和查看
- **自适应时间分组**：根据时间戳自动将日志分组
- **实时内存监控**：使用psutil监控内存使用，自动优化处理策略
- **智能扫描模式**：根据文件大小自动选择最佳处理策略
- **断点续扫**：支持中断后继续扫描，不丢失已处理的结果

## 系统要求

- **操作系统**：Windows, macOS, Linux
- **Python**：Python 3.7+
- **依赖库**：PyQt5, toml, psutil, py7zr等(见requirements.txt)
- **硬件**：
  - CPU：建议多核处理器
  - 内存：最小4GB，建议8GB以上
  - 磁盘空间：程序本身约50MB，运行时临时文件视日志大小而定

## 快速开始

### 克隆仓库

```bash
git clone https://github.com/ashllll/log_hightlight.git
cd log_hightlight
```

### 启动应用

项目提供了统一的启动脚本，会自动检查环境、安装依赖并启动应用：

#### Windows系统

直接双击 `run_unified.bat` 文件，或在命令行中运行：

```bash
run_unified.bat
```

#### Linux/macOS系统

在终端中运行：

```bash
chmod +x run_unified.sh  # 只需首次运行时执行
./run_unified.sh
```

### 统一启动脚本功能

统一启动脚本(`run_unified.bat`/`run_unified.sh`)提供以下功能：

1. **自动环境检测**：检查Python环境是否正确安装
2. **依赖管理**：自动检查并安装所需依赖
   - 优先从本地`libs`目录安装(离线模式)
   - 如本地安装失败，尝试从网络安装
3. **平台兼容性检查**：确保程序能在当前系统上正常运行
4. **错误处理**：捕获并显示错误信息，提供用户友好的提示
5. **OS特定优化**：针对不同操作系统自动应用最佳配置

## 详细使用指南

### 图形界面使用

启动应用后，您将看到主界面，主要包含以下部分：

1. **配置部分**：
   - 可选择TOML配置文件设置关键词组
   - 设置CPU核心使用数量
   - 配置扫描模式和其他参数

2. **日志源部分**：
   - 添加目录：添加包含日志文件的整个目录
   - 添加文件：添加单个日志文件
   - 添加压缩包：添加压缩格式的日志文件
   - 解压选中文件：解压选定的压缩文件

3. **关键词部分**：
   - 预定义关键词组：从配置文件加载的关键词组
   - 自定义关键词：添加临时关键词进行搜索
   - 关键词颜色：为不同关键词设置不同的高亮颜色

4. **控制按钮**：
   - 开始分析：开始日志分析过程
   - 取消：停止正在进行的分析
   - 预览结果：查看分析结果

### 配置文件说明

程序使用TOML格式的配置文件来定义关键词组。配置文件示例(keywords.toml)：

```toml
[groups]
# 错误关键词组
[groups.error]
color = "#ff6666"
keywords = [
    {raw = "ERROR", match_case = true, whole_word = true},
    {raw = "Exception", match_case = false, whole_word = false},
    {raw = "failed", match_case = false, whole_word = false},
    {raw = "failure", match_case = false, whole_word = false}
]

# 警告关键词组
[groups.warning]
color = "#ffcc66"
keywords = [
    {raw = "WARNING", match_case = true, whole_word = true},
    {raw = "WARN", match_case = true, whole_word = true},
    {raw = "attention", match_case = false, whole_word = false}
]

# 自定义正则表达式示例
[groups.regex_examples]
color = "#99ccff"
keywords = [
    {raw = "IP: \\d{1,3}\\.\\d{1,3}\\.\\d{1,3}\\.\\d{1,3}", use_regex = true},
    {raw = "ID: [A-Z0-9]{8,}", use_regex = true}
]
```

配置选项说明：
- `raw`：要匹配的文本或正则表达式
- `match_case`：是否区分大小写（默认: false）
- `whole_word`：是否匹配整个单词（默认: false）
- `use_regex`：是否将文本作为正则表达式处理（默认: false）
- `color`：高亮颜色，十六进制格式

### 命令行使用

除了图形界面外，也可以通过命令行直接使用：

```bash
python main.py --input <日志文件或目录> --keywords <关键词列表>
```

命令行参数：
- `--input`：指定要扫描的日志文件或目录路径
- `--keywords`：指定要高亮的关键词列表，用逗号分隔
- `--config`：指定配置文件路径（可选）
- `--output`：指定输出目录（可选，默认为当前目录）
- `--mode`：扫描模式，可选值：auto, fast, accurate, balanced（可选，默认为auto）

### 离线使用说明

本工具支持在无网络环境下使用：

1. 在有网络的环境中，运行启动脚本，它会自动下载所需依赖到`libs`目录
2. 将整个目录（包括libs）复制到离线环境
3. 在离线环境中运行启动脚本，它会使用本地`libs`目录中的依赖

## 高级功能

### 扫描模式

- **自动模式**：
  - 根据文件大小自动选择最佳扫描策略
  - 动态调整线程数和内存使用
  - 适合大多数使用场景
- **快速模式**：
  - 使用预过滤和位图过滤技术
  - 最大化扫描速度
  - 适合初步分析或大规模日志扫描
- **精确模式**：
  - 禁用预过滤，使用完整正则表达式匹配
  - 确保不遗漏任何匹配项
  - 适合需要高精度结果的场景
- **平衡模式**：
  - 在速度和精确度之间取得平衡
  - 使用智能缓存策略
  - 适合常规日志分析任务

### 性能调优

- **最大结果数**：限制每个文件的最大结果数，避免内存溢出
- **CPU核心数**：调整使用的CPU核心数，提高并行处理能力
- **关键词预过滤**：启用预过滤可加快处理速度，但可能略微降低匹配精度
- **位图过滤**：使用位图过滤技术加速大型日志文件的处理
- **内存管理**：
  - 动态内存监控和优化
  - 大文件分块处理
  - 自动垃圾回收
  - 内存压力预警

### 结果分析

分析结果以HTML报告形式呈现，包含以下内容：

- 按时间范围分组的日志条目
- 每个关键词的匹配数量统计
- 高亮显示的关键词，使用不同颜色区分
- 可点击的时间戳，便于定位原始日志位置
- 摘要信息，包括：
  - 处理文件总数和大小
  - 各类关键词匹配数量
  - 处理耗时统计
  - 内存使用情况
  - 可能的警告或建议

## 代码架构

详细的代码架构和流程图请参见 [architecture_and_flowchart.md](architecture_and_flowchart.md) 文件。

主要模块包括：

- `main.py`：应用程序入口点
- `log_hightlight.py`：核心功能实现
- `keyword_matcher.py`：关键词匹配算法
- `file_handler.py`：文件处理逻辑
- `memory_manager.py`：内存管理和优化
- `platform_check.py`：平台兼容性检查
- `utils.py`：通用工具函数

## 问题排查

### 常见问题

1. **依赖安装失败**
   - 确保网络连接正常
   - 尝试手动安装：`pip install -r requirements.txt`
   - 如果PyQt5安装失败，尝试：`pip install PyQt5==5.15.11`

2. **程序启动失败**
   - 检查Python版本（需要3.7+）
   - 确认所有依赖正确安装
   - 查看日志文件`log_highlighter.log`获取详细错误信息

3. **内存不足**
   - 减少同时处理的文件数量
   - 降低最大结果数限制
   - 使用"快速模式"减少内存消耗
   - 关闭其他内存密集型应用

### 日志位置

程序产生的日志文件位于应用程序根目录下的`log_highlighter.log`。出现问题时，请查看此文件获取详细的错误信息。

## 许可证

本项目采用MIT许可证 - 详情请见[LICENSE.md](LICENSE.md)文件。

## 贡献

欢迎提交问题和拉取请求。对于重大更改，请先开一个issue讨论您想要更改的内容。

## 更新日志

- **1.0.0** - 初始版本
  - 基本的日志扫描和高亮功能
  - 简单的GUI界面
  
- **1.1.0** - 添加压缩文件支持和性能优化
  - 支持多种压缩格式
  - 添加内存优化功能
  - 改进GUI界面
  
- **1.2.0** - 功能增强更新
  - 引入统一启动脚本
  - 改进的错误处理
  - 添加断点续扫功能
  - 优化内存管理
  - 添加实时内存监控
  - 改进HTML报告样式
  
- **1.3.0** - 即将发布
  - 支持更多压缩格式
  - 添加自定义主题
  - 改进搜索算法
  - 优化大文件处理
  - 添加导出功能
  - 支持更多配置选项
